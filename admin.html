<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title data-i18n="admin_add">Admin - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f5f9fc;
      color: #333;
      padding: 30px;
    }

    input,
    button {
      background-color: #ffffff;
      color: #333;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 10px;
      width: 300px;
      margin: 10px 0;
    }

    button {
      background-color: #5aa9e6;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    button:hover {
      background-color: #3c8cd4;
    }

    .movie-preview {
      margin-top: 30px;
    }

    .movie-card {
      background-color: #ffffff;
      padding: 20px;
      margin: 15px 0;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .lang-switch {
      text-align: right;
      margin-bottom: 10px;
    }

    #clearBtn {
      background: #f87171;
    }

    #clearBtn:hover {
      background: #ef4444;
    }
  </style>
</head>

<body>
  <script>
    const adminCode = "12345";
    const input = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô:");
    if (input !== adminCode) {
      alert("‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
      window.location.href = "index.html";
    }
  </script>

  <div class="lang-switch">
    <button onclick="setLang('th')">TH</button>
    <button onclick="setLang('en')">EN</button>
  </div>

  <h1 data-i18n="admin_add">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á‡πÉ‡∏´‡∏°‡πà</h1>
  <form id="movieForm">
    <input type="text" id="title_th" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á (TH)" required>
    <input type="text" id="title_en" placeholder="Movie Title (EN)" required>
    <input type="text" id="poster" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÇ‡∏õ‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå ‡πÄ‡∏ä‡πà‡∏ô images/.jpg ‡∏´‡∏£‡∏∑‡∏≠ https://..." required>
    <input type="text" id="showtimes" placeholder="‡∏£‡∏≠‡∏ö‡∏â‡∏≤‡∏¢ (‡πÄ‡∏ä‡πà‡∏ô 12:00, 15:00)" required>
    <button type="submit" data-i18n="add_movie">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á</button>
  </form>
  

  <div class="movie-preview">
    <h2 data-i18n="all_movies">‡∏´‡∏ô‡∏±‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
    <div id="movieList"></div>

    <hr><br>
    <h2 data-i18n="all_bookings">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
    <button onclick="refreshData()" style="margin-bottom: 20px;">üîÅ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    <div id="summaryBox"
      style="background:#fff;padding:15px;border-radius:10px;box-shadow:0 0 8px rgba(0,0,0,0.05);margin-bottom:20px;">
      <p>‚è≥ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>
    <div id="bookingList"></div>

    <button onclick="clearBookings()" id="clearBtn" style="
      margin-top:20px;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      transition: 0.3s;
    ">
      ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    </button>
  </div>

  <script>
    
    let currentLang = localStorage.getItem("lang") || "th";

    function setLang(lang) {
      currentLang = lang;
      localStorage.setItem("lang", lang);
      loadLang();
      loadMovies();
      loadBookings();
    }

    function loadLang() {
      fetch("lang.json")
        .then(res => res.json())
        .then(data => {
          const dict = data[currentLang];
          document.querySelectorAll("[data-i18n]").forEach(el => {
            const key = el.getAttribute("data-i18n");
            if (dict[key]) el.innerText = dict[key];
          });
          const clearBtn = document.getElementById("clearBtn");
          if (clearBtn && dict.clear_all) clearBtn.innerText = "üîÑ " + dict.clear_all;
        });
    }

    const form = document.getElementById("movieForm");
    const movieList = document.getElementById("movieList");

    function loadMovies() {
  fetch("movies.json?_=" + new Date().getTime())
    .then(res => res.json())
    .then(data => {
      movieList.innerHTML = '';
      data.forEach((movie, index) => {
        const title = movie.title[currentLang];
        const card = document.createElement("div");
        card.className = "movie-card";
        card.innerHTML = `
          <strong>${title}</strong><br>
          <img src="${movie.poster}" alt="" width="120" onerror="this.src='images/default.jpg'"><br>
          ${movie.showtimes.join(', ')}<br><br>
          <button onclick="deleteMovie(${index})" style="background:#ef4444;color:white;padding:5px 10px;border:none;border-radius:6px;cursor:pointer;">üóë ‡∏•‡∏ö‡∏´‡∏ô‡∏±‡∏á</button>
        `;
        movieList.appendChild(card);
      });
    });
}

function deleteMovie(index) {
  if (!confirm(currentLang === "th" ? "‡∏•‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?" : "Delete this movie?")) return;

  fetch("delete_movie.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ index })
  })
    .then(res => res.json())
    .then(data => {
      alert(data.message || "‡∏•‡∏ö‡∏´‡∏ô‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
      loadMovies();
    });
}

function loadBookings() {
  fetch("bookings.json?_=" + new Date().getTime())
    .then(res => res.json())
    .then(data => {
      updateSummary(data); // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
      const bookingList = document.getElementById("bookingList");
      bookingList.innerHTML = "";

      if (!data.length) {
        bookingList.innerHTML = `<p>${currentLang === "th" ? "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á" : "No bookings found"}</p>`;
        return;
      }

      fetch("lang.json")
        .then(res => res.json())
        .then(dictData => {
          const dict = dictData[currentLang];
          data.forEach((b, i) => {
            const total = b.seats.reduce((sum, s) => sum + (s.type === "vip" ? 200 : 120), 0);
            const seats = b.seats.map(s => `${s.index} (${s.type === "vip" ? dict.zone_vip : dict.zone_normal})`).join(", ");

            const item = document.createElement("div");
            item.style = "background:#fff;padding:10px;margin:10px 0;border-radius:8px;box-shadow:0 0 5px rgba(0,0,0,0.05)";
            item.innerHTML = `
              <strong>#${i + 1}</strong><br>
              üé¨ ${dict.movie}: ${b.movie_id}<br>
              ‚è∞ ${dict.showtime}: ${b.showtime}<br>
              üí∫ ${dict.selected_seats}: ${seats}<br>
              üíµ ${dict.total}: ${total} ${dict.currency}<br>
              üïí ${dict.time || "Time"}: ${new Date(b.timestamp).toLocaleString()}
            `;
            bookingList.appendChild(item);
          });
        });
    });
}


    function updateSummary(data) {
      const summaryBox = document.getElementById("summaryBox");

      if (!data.length) {
        summaryBox.innerHTML = `<p>${currentLang === "th" ? "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á" : "No booking data"}</p>`;
        return;
      }

      let totalBookings = data.length;
      let totalSeats = 0;
      let totalIncome = 0;
      const times = new Set();

      data.forEach(b => {
        totalSeats += b.seats.length;
        totalIncome += b.seats.reduce((sum, s) => sum + (s.type === "vip" ? 200 : 120), 0);
        times.add(`${b.movie_id}-${b.showtime}`);
      });

      summaryBox.innerHTML = `
        <p>üì¶ ${currentLang === "th" ? "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á" : "Total bookings"}: <strong>${totalBookings}</strong></p>
        <p>üí∫ ${currentLang === "th" ? "‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" : "Total seats booked"}: <strong>${totalSeats}</strong></p>
        <p>üé¨ ${currentLang === "th" ? "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á" : "Unique movie sessions"}: <strong>${times.size}</strong></p>
        <p>üí∞ ${currentLang === "th" ? "‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°" : "Total income"}: <strong>${totalIncome.toLocaleString()} ‡∏ö‡∏≤‡∏ó</strong></p>
      `;
    }

    fetch("bookings.json?_=" + new Date().getTime())
  .then(res => res.json())
  .then(data => {
    updateSummary(data);
    const bookingList = document.getElementById("bookingList");
    bookingList.innerHTML = "";

    if (!data.length) {
      bookingList.innerHTML = `<p>${currentLang === "th" ? "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á" : "No bookings found"}</p>`;
      return;
    }

    fetch("lang.json")
      .then(res => res.json())
      .then(dictData => {
        const dict = dictData[currentLang];

        data.forEach((b, i) => {
          const total = b.seats.reduce((sum, s) => sum + (s.type === "vip" ? 200 : 120), 0);
          const seats = b.seats.map(s => `${s.index} (${s.type === "vip" ? dict.zone_vip : dict.zone_normal})`).join(", ");

          const item = document.createElement("div");
          item.style = "background:#fff;padding:10px;margin:10px 0;border-radius:8px;box-shadow:0 0 5px rgba(0,0,0,0.05)";
          item.innerHTML = `
            <strong>#${i + 1}</strong><br>
            üé¨ ${dict.movie}: ${b.movie_id}<br>
            ‚è∞ ${dict.showtime}: ${b.showtime}<br>
            üí∫ ${dict.selected_seats}: ${seats}<br>
            üíµ ${dict.total}: ${total} ${dict.currency}<br>
            üïí ${dict.time || "Time"}: ${new Date(b.timestamp).toLocaleString()}
          `;
          bookingList.appendChild(item);
        });
      });
  });


    function clearBookings() {
      if (!confirm(currentLang === "th" ? "‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?" : "Are you sure you want to clear all bookings?")) return;

      fetch("clear_bookings.php", { method: "POST" })
        .then(res => res.json())
        .then(data => {
          alert(data.message || "‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
          loadBookings();
        });
    }

    loadLang();
    loadMovies();
    loadBookings();

    form.addEventListener("submit", function (e) {
  e.preventDefault();

  const titleTH = document.getElementById("title_th").value.trim();
  const titleEN = document.getElementById("title_en").value.trim();
  const poster = document.getElementById("poster").value.trim();
  const showtimes = document.getElementById("showtimes").value.split(",").map(s => s.trim());

  const isValidPoster = /^https?:\/\//.test(poster) || /^images\/.+/.test(poster);
  if (!isValidPoster) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÄ‡∏ä‡πà‡∏ô images/... ‡∏´‡∏£‡∏∑‡∏≠ http://...");
    return;
  }
  fetch("save_movie.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      title: { th: titleTH, en: titleEN },
      poster,
      showtimes
    })
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message || "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
    form.reset();
    loadMovies();
  })
  .catch(err => {
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
    console.error(err);
  });
});


  </script>
</body>

</html>